name: Render Video

on:
  repository_dispatch:
    types: [render-video]

permissions:
  contents: write

jobs:
  render:
    name: Render Video Clip
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Dependencies
        run: npm ci

      - name: Download Source Video
        env:
          VIDEO_URL: ${{ github.event.client_payload.videoUrl }}
        run: |
          mkdir -p videos
          curl -L -o video.mp4 "$VIDEO_URL"
          echo "Downloaded video from: $VIDEO_URL"
          ls -lh video.mp4

      - name: Create Props File
        env:
          PROPS_JSON: '${{ toJson(github.event.client_payload.props) }}'
        run: |
          echo "$PROPS_JSON" > src/props.json
          echo "Props file created:"
          cat src/props.json

      - name: Render Video with Remotion
        env:
          VIDEO_URL: ${{ github.event.client_payload.videoUrl }}
          PROPS_JSON: '${{ toJson(github.event.client_payload.props) }}'
        run: |
          # Create rendering script
          cat > render-script.mjs << 'EOF'
          import { bundle } from "@remotion/bundler";
          import { renderMedia, selectComposition } from "@remotion/renderer";
          import fs from "fs/promises";

          const props = JSON.parse(process.env.PROPS_JSON);

          // Override videoSrc with local file
          props.videoSrc = "./video.mp4";

          console.log("Props:", JSON.stringify(props, null, 2));

          // Bundle the Remotion project
          const bundleLocation = await bundle({
            entryPoint: "./src/index.ts",
            webpackOverride: (config) => config,
          });

          console.log("Bundle complete:", bundleLocation);

          // Get composition
          const composition = await selectComposition({
            compositionId: "VideoComposition",
            inputProps: props,
            serveUrl: bundleLocation,
          });

          console.log("Composition:", composition.id, "Duration:", composition.durationInFrames);

          // Create output directory
          await fs.mkdir("output", { recursive: true });

          // Render video
          await renderMedia({
            composition,
            inputProps: props,
            serveUrl: bundleLocation,
            outputLocation: `output/${props.id}.mp4`,
            codec: "h264",
          });

          console.log("Render complete: output/" + props.id + ".mp4");
          EOF

          # Run rendering script
          node render-script.mjs

      - name: Verify Output
        run: |
          ls -lh output/
          if [ ! -f output/*.mp4 ]; then
            echo "Error: No video file generated"
            exit 1
          fi
          echo "Video rendered successfully"

      - name: Upload Result as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rendered-video-${{ github.event.client_payload.jobId }}
          path: output/*.mp4
          retention-days: 1

      - name: Upload Result to Temporary Storage
        id: upload
        run: |
          VIDEO_FILE=$(ls output/*.mp4 | head -1)
          RESPONSE=$(curl -F "file=@$VIDEO_FILE" https://file.io)
          echo "Upload response: $RESPONSE"
          DOWNLOAD_URL=$(echo "$RESPONSE" | jq -r '.link')
          echo "Download URL: $DOWNLOAD_URL"
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT

      - name: Create Output Summary
        run: |
          echo "## Render Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Job ID:** ${{ github.event.client_payload.jobId }}" >> $GITHUB_STEP_SUMMARY
          echo "**Download URL:** ${{ steps.upload.outputs.download_url }}" >> $GITHUB_STEP_SUMMARY

      - name: Send Webhook Callback
        if: success()
        env:
          WEBHOOK_URL: ${{ github.event.client_payload.webhookUrl }}
        run: |
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "jobId": "${{ github.event.client_payload.jobId }}",
              "status": "completed",
              "downloadUrl": "${{ steps.upload.outputs.download_url }}"
            }'
